generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  STORE
}

enum OrderStatus {
  PENDING
  PAID
  CANCELED
}

enum ArSource {
  WEB
  IOS
  ANDROID
  UNKNOWN
}

model Store {
  id             Int       @id @default(autoincrement())
  name           String
  slug           String    @unique
  logoUrl        String?
  description    String?
  whatsapp       String?
  address        String?
  ai3dCredits    Int       @default(3)  // Free credits for new stores
  ai3dUsed       Int       @default(0)  // Total models generated
  subscriptionTier String? @default("FREE") // FREE, BASIC, PRO, ENTERPRISE
  createdAt      DateTime  @default(now())
  products       Product[]
  users          User[]
  orders         Order[]
  arViews        ArView[]
  creditPurchases CreditPurchase[]
}

model CreditPurchase {
  id          Int      @id @default(autoincrement())
  store       Store    @relation(fields: [storeId], references: [id])
  storeId     Int
  credits     Int      // Number of credits purchased
  amount      Decimal  @db.Decimal(10, 2) // Amount paid in ARS/USD
  currency    String   @default("ARS")
  paymentId   String?  // Mercado Pago payment ID
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt   DateTime @default(now())

  @@index([storeId])
  @@index([paymentId])
}

model Product {
  id          Int            @id @default(autoincrement())
  store       Store          @relation(fields: [storeId], references: [id])
  storeId     Int
  name        String
  slug        String         @unique
  description String?
  price       Decimal        @db.Decimal(10, 2)
  category    String?
  room        String?
  style       String?
  widthCm     Decimal?       @db.Decimal(6, 2)
  heightCm    Decimal?       @db.Decimal(6, 2)
  depthCm     Decimal?       @db.Decimal(6, 2)
  weightKg    Decimal?       @db.Decimal(6, 2)
  material    String?
  color       String?
  arUrl       String?
  imageUrl    String?
  inStock     Boolean        @default(true)
  stockQty    Int            @default(0)
  featured    Boolean        @default(false)
  views       Int            @default(0)
  createdAt   DateTime       @default(now())
  images      ProductImage[]
  orderItems  OrderItem[]
  arViews     ArView[]
}

model ProductImage {
  id        Int      @id @default(autoincrement())
  product   Product  @relation(fields: [productId], references: [id])
  productId Int
  url       String
  altText   String?
  position  Int      @default(0)
  type      String?
}

model Order {
  id         Int          @id @default(autoincrement())
  store      Store        @relation(fields: [storeId], references: [id])
  storeId    Int
  user       User?        @relation(fields: [userId], references: [id])
  userId     Int?
  status     OrderStatus  @default(PAID)
  total      Decimal      @db.Decimal(12, 2)
  customer   String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  items      OrderItem[]
}

model OrderItem {
  id         Int      @id @default(autoincrement())
  order      Order    @relation(fields: [orderId], references: [id])
  orderId    Int
  product    Product  @relation(fields: [productId], references: [id])
  productId  Int
  quantity   Int
  unitPrice  Decimal  @db.Decimal(10, 2)
  subtotal   Decimal  @db.Decimal(12, 2)
}

model ArView {
  id         Int       @id @default(autoincrement())
  product    Product   @relation(fields: [productId], references: [id])
  productId  Int
  store      Store?    @relation(fields: [storeId], references: [id])
  storeId    Int?
  source     ArSource  @default(UNKNOWN)
  createdAt  DateTime  @default(now())

  @@index([productId])
  @@index([storeId])
  @@index([createdAt])
}

model User {
  id           Int                    @id @default(autoincrement())
  email        String                 @unique
  name         String?
  passwordHash String
  role         Role                   @default(STORE)
  storeId      Int?
  store        Store?                 @relation(fields: [storeId], references: [id])
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  orders       Order[]
  resetTokens  PasswordResetToken[]
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)

  @@index([token])
  @@index([userId])
}

enum AI3DJobStatus {
  PENDING
  IN_PROGRESS
  SUCCEEDED
  FAILED
}

model AI3DJob {
  id          Int            @id @default(autoincrement())
  productId   Int
  imageUrl    String
  provider    String         @default("meshy") // meshy, luma, tripo, etc
  taskId      String?        // ID del task en el proveedor
  status      AI3DJobStatus  @default(PENDING)
  glbUrl      String?        // URL del modelo generado (Cloudinary)
  errorMsg    String?
  metadata    Json?          // datos extra del proveedor
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([productId])
  @@index([status])
  @@index([taskId])
}
